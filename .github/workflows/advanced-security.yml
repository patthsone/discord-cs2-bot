name: Advanced Security Scan

on:
  workflow_dispatch: # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  schedule:
    - cron: '0 3 * * 0' # ÐšÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² 3:00 UTC

jobs:
  advanced-security:
    runs-on: ubuntu-latest
    if: secrets.SNYK_TOKEN != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high --sarif-file-output=snyk.sarif
      continue-on-error: true
      
    - name: Upload Snyk results to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('snyk.sarif') != ''
      with:
        sarif_file: snyk.sarif
        
    - name: Security report
      if: always()
      run: |
        echo "## ðŸ”’ Advanced Security Scan" >> $GITHUB_STEP_SUMMARY
        if [ -f snyk.sarif ]; then
          echo "- âœ… Snyk scan completed" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Results uploaded to GitHub Security tab" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Snyk scan failed or no issues found" >> $GITHUB_STEP_SUMMARY
        fi
